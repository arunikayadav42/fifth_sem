create database lab6;
use lab6;

create table BRANCH(BranchID varchar(255) NOT NULL UNIQUE,
branch_name varchar(255) NOT NULL UNIQUE,
branch_city varchar(255),
assets varchar(255) NOT NULL,
ModifiedDate date,
PRIMARY KEY(BranchID, branch_name));

create table ACCOUNT(
AccountID varchar(255) NOT NULL PRIMARY KEY,
BranchID varchar(255) ,
AccountNumber bigint ,
AccountType varchar(255),
Balance bigint,
ModifiedDate date,
FOREIGN KEY (BranchID) REFERENCES BRANCH(BranchID) ON DELETE CASCADE
);

create table CUSTOMER(CustomerID varchar(255) NOT NULL,
Name varchar(255),
Street varchar(255),
City varchar(255),
State varchar(255),
Zip bigint,
Country varchar(255),
ModifiedDate date,
PRIMARY KEY(CustomerID));

create table LOAN(
LoanID varchar (255) NOT NULL,
AccountID varchar(255),
BranchID varchar(255),
LoanNumber bigint,
Loantype varchar(255),
Amount bigint,
ModifiedDate date,
PRIMARY KEY(LoanID),
FOREIGN KEY ( AccountID ) REFERENCES ACCOUNT(AccountID) ON DELETE CASCADE,
FOREIGN KEY ( BranchID ) REFERENCES BRANCH(BranchID) ON DELETE CASCADE
);

create table DEPOSITOR(CustomerID VARCHAR(255) NOT NULL,
AccountID VARCHAR(255) NOT NULL,
ModifiedDate date,
PRIMARY KEY ( CustomerID, AccountID ),
FOREIGN KEY ( AccountID ) REFERENCES ACCOUNT(AccountID) ON DELETE CASCADE,
FOREIGN KEY ( CustomerID ) REFERENCES CUSTOMER(CustomerID) ON DELETE CASCADE);


create table BORROWER(CustomerID VARCHAR(255) not null,
LoanID VARCHAR(255) not null,
ModifiedDate date,
PRIMARY KEY ( CustomerID, LoanID ),
FOREIGN KEY ( CustomerID ) REFERENCES CUSTOMER(CustomerID) ON DELETE CASCADE,
FOREIGN KEY ( LoanID ) REFERENCES LOAN(LoanID) ON DELETE CASCADE); 

create table TRANSACTIONS(
TransactionID varchar(255) not null,
AccountID varchar(255),
TranType varchar(255),
Amount bigint,
ModifiedDate date,
PRIMARY KEY ( TransactionID ),
FOREIGN KEY ( AccountID ) REFERENCES ACCOUNT(AccountID) ON DELETE CASCADE
);

/*1*/
INSERT INTO BRANCH VALUES('B1', 'A', 'PATNA', 'HOUSE', '2018-05-09');
INSERT INTO BRANCH VALUES('B2', 'B', 'BIHTA', 'CAR', '2017-05-09');
INSERT INTO BRANCH VALUES('B3', 'C', 'KANPUR', 'BIKE', '2018-07-09');
INSERT INTO BRANCH VALUES('B4', 'D', 'LKO', 'FAN', '2016-05-09');
INSERT INTO BRANCH VALUES('B5', 'E', 'NAGPUR', 'HOUSE', '2015-05-09');
INSERT INTO BRANCH VALUES('B6', 'F', 'PATNA', 'LAND', '2018-05-15');
INSERT INTO BRANCH VALUES('B7', 'G', 'KANPUR', 'HOUSE', '2018-05-23');
INSERT INTO BRANCH VALUES('B8', 'H', 'ARA', 'MACHINE', '2008-05-09');
INSERT INTO BRANCH VALUES('B9', 'J', 'DANAPUR', 'DESKTOP', '2018-02-09');
INSERT INTO BRANCH VALUES('B10', 'K', 'PATNA', 'HOUSE', '2018-01-09');

/*2*/
INSERT INTO ACCOUNT VALUES('1','B1','00001','Current','3000','2015-03-19');
INSERT INTO ACCOUNT VALUES('2','B2','00002','Savings','10000','2015-03-19');
INSERT INTO ACCOUNT VALUES('3','B3','00003','Savings','2500','2015-03-19');
INSERT INTO ACCOUNT VALUES('4','B4','00004','Current','2900','2015-03-19');
INSERT INTO ACCOUNT VALUES('5','B5','00005','Savings','300','2015-03-19');
INSERT INTO ACCOUNT VALUES('6','B6','00006','Savings','100000','2015-03-19');
INSERT INTO ACCOUNT VALUES('7','B7','00007','Current','100000','2015-03-19');
INSERT INTO ACCOUNT VALUES('8','B8','00008','Savings','3000','2015-03-19');
INSERT INTO ACCOUNT VALUES('9','B9','00009','Current','200','2015-03-19');
INSERT INTO ACCOUNT VALUES('10','B10','0010','Savings','100000','2015-03-19');

/*3*/
INSERT INTO CUSTOMER VALUES('C1', 'ARUN', 'PATLIPUTRA', 'PATNA', 'BIHAR', '801103', 'INDIA', '2015-03-19');
INSERT INTO CUSTOMER VALUES('C2', 'ARUNIKA', 'MALL', 'BIHTA', 'BIHAR', '801103', 'INDIA', '2015-03-19');
INSERT INTO CUSTOMER VALUES('C3', 'RAHUL', 'BORING', 'KANPUR', 'UP', '801103', 'INDIA', '2015-03-19');
INSERT INTO CUSTOMER VALUES('C4', 'RIYA', 'FRASER', 'PATNA', 'BIHAR', '801103', 'INDIA', '2015-03-19');
INSERT INTO CUSTOMER VALUES('C5', 'RIYA', 'PATLI', 'LKO', 'UP', '801103', 'INDIA', '2015-03-19');
INSERT INTO CUSTOMER VALUES('C6', 'HARSH', 'CIVIL', 'NAGPUR', 'MP', '801103', 'INDIA', '2015-03-19');
INSERT INTO CUSTOMER VALUES('C7', 'RIMA', 'MAIN', 'PATNA', 'BIHAR', '801103', 'INDIA', '2015-03-19');
INSERT INTO CUSTOMER VALUES('C8', 'SIMA', 'NAVEEN', 'KANPUR', 'UP', '801103', 'INDIA', '2015-03-19');
INSERT INTO CUSTOMER VALUES('C9', 'PIYA', 'NEW', 'ARA', 'BIHAR', '801103', 'INDIA', '2015-03-19');
INSERT INTO CUSTOMER VALUES('C10', 'ARUNI', 'CIVILIAN', 'DANAPUR', 'BIHAR', '801103', 'INDIA', '2015-03-19');

/*4*/
/*4*/
INSERT INTO LOAN VALUES ('L1', '1','B1','0001','Personal', '10000','2017-11-09');
INSERT INTO LOAN VALUES ('L2', '2','B2','0002','Home', '10000','2017-11-09');
INSERT INTO LOAN VALUES ('L3', '2','B2','0003','Car', '10000','2017-11-09');
INSERT INTO LOAN VALUES ('L4', '1','B1','0004','Home', '10000','2017-11-09');
INSERT INTO LOAN VALUES ('L5', '3','B3','0005','Personal', '10000','2017-11-09');
INSERT INTO LOAN VALUES ('L6', '3','B3','0006','Personal', '10000','2017-11-09');
INSERT INTO LOAN VALUES ('L7', '4','B4','0007','Car', '10000','2017-11-09');
INSERT INTO LOAN VALUES ('L8', '5','B5','0008','Personal', '10000','2017-11-09');
INSERT INTO LOAN VALUES ('L9', '6','B6','0009','Home', '10000','2017-11-09');
INSERT INTO LOAN VALUES ('L10', '10','B10','0010','Personal', '10000','2017-11-09');

/*5*/
INSERT INTO DEPOSITOR VALUES('C1', '1', '2018-05-07');
INSERT INTO DEPOSITOR VALUES('C2', '2', '2017-05-07');
INSERT INTO DEPOSITOR VALUES('C3', '3', '2018-07-07');
INSERT INTO DEPOSITOR VALUES('C4', '4', '2018-05-21');
INSERT INTO DEPOSITOR VALUES('C5', '5', '2018-05-07');
INSERT INTO DEPOSITOR VALUES('C6', '6', '2015-05-07');
INSERT INTO DEPOSITOR VALUES('C7', '7', '2016-05-07');
INSERT INTO DEPOSITOR VALUES('C8', '8', '2009-05-07');
INSERT INTO DEPOSITOR VALUES('C9', '9', '2056-05-07');
INSERT INTO DEPOSITOR VALUES('C10', '10', '2018-08-07');

/*6*/
INSERT INTO BORROWER VALUES('C1', 'L1', '2018-05-07');
INSERT INTO BORROWER VALUES('C1', 'L3', '2018-05-07');
INSERT INTO BORROWER VALUES('C4', 'L5', '2018-05-07');
INSERT INTO BORROWER VALUES('C5', 'L6', '2018-05-07');
INSERT INTO BORROWER VALUES('C6', 'L8', '2018-05-07');
INSERT INTO BORROWER VALUES('C7', 'L9', '2018-05-07');
INSERT INTO BORROWER VALUES('C9', 'L10', '2018-05-07');
INSERT INTO BORROWER VALUES('C3', 'L7', '2018-05-07');
INSERT INTO BORROWER VALUES('C10', 'L4', '2018-05-07');
INSERT INTO BORROWER VALUES('C1', 'L2', '2018-05-07');

/*7*/
INSERT INTO TRANSACTIONS VALUES('0001','1','Loan Payment','1000','2018-02-03');
INSERT INTO TRANSACTIONS VALUES('0002','2','Simple Withdraw','1000','2018-02-03');
INSERT INTO TRANSACTIONS VALUES('0003','3','Simple Deposit','1000','2018-02-03');
INSERT INTO TRANSACTIONS VALUES('0004','4','Simple Withdraw','1000','2018-02-03');
INSERT INTO TRANSACTIONS VALUES('0005','5','Simple Withdraw','1000','2018-02-03');
INSERT INTO TRANSACTIONS VALUES('0006','6','Loan Payment','1000','2018-02-03');
INSERT INTO TRANSACTIONS VALUES('0007','7','Simple Deposit','1000','2018-02-03');
INSERT INTO TRANSACTIONS VALUES('0008','8','Simple Withdraw','1000','2018-02-03');
INSERT INTO TRANSACTIONS VALUES('0009','9','Loan Payment','1000','2018-02-03');
INSERT INTO TRANSACTIONS VALUES('0010','10','Loan Taken','1000','2018-02-03');
INSERT INTO TRANSACTIONS VALUES('0011','1','Simple Deposit','1000','2018-02-03');

start transaction;
/*1*/
UPDATE ACCOUNT SET BALANCE = BALANCE-((3*BALANCE)/100) WHERE BALANCE < 3000; 
SELECT * FROM ACCOUNT;

/*2*/
SAVEPOINT sp1;
delete from CUSTOMER WHERE CustomerID in (select CustomerID from DEPOSITOR
where AccountID in (select AccountID from ACCOUNT where Balance < 500));


/*3*/ 
select CUSTOMER.CustomerID, CUSTOMER.Name, CUSTOMER.Street, 
CUSTOMER.City, CUSTOMER.State, CUSTOMER.Zip, CUSTOMER.Country, 
CUSTOMER.ModifiedDate, Count(BORROWER.LoanID) as loans 
from BORROWER left JOIN CUSTOMER on CUSTOMER.CustomerID = BORROWER.CustomerID group by CUSTOMER.CustomerID 
having loans >= 2;   

/*4*/
delete from CUSTOMER where CustomerID in 
(select CustomerID from BORROWER
left join LOAN on LOAN.LoanID = BORROWER.LoanID group by CustomerID having
count(distinct LoanType) = 3);

/*5*/
ROLLBACK TO sp1;
COMMIT;

/*6*/
LOCK TABLE ACCOUNT READ;
UPDATE ACCOUNT SET Balance = 1.05*Balance
WHERE Balance > 10000;

/*7*/
UNLOCK TABLES;
LOCK TABLE ACCOUNT WRITE;
UPDATE ACCOUNT SET Balance = 1.05*Balance
WHERE Balance > 10000;

/*8*/
UNLOCK TABLES;










